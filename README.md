Dtest
======

Dtest は、データの単体検証をターゲットとした、テスト用ライブラリです。

1. Background
--------------

ソフトウェアの開発には、テストが不可欠です。その中でも単体テストについては、多くの自動化ツールが開発・公開されており、C++で開発されたプロダクトについても、Google Test (https://code.google.com/p/googletest/) 等、単体テスト向けフレームワークが開発・公開されています。

しかし、ソフトウェアが利用する「データ」に関する検証については、確立されたフレームワークが未だ存在しないように思います。そうなると、なんとなく単体テストと同じように作ってしまうか、もしくはフルスクラッチで作成するか、といった選択肢になってきます。

しかしながら、データの検証は、従来のテストと性質が異なる点がいくつかあります。なぜならば、データのテストでは、反復するデータに対して、順次チェックを行うからです。従来のテストと異なる点の例を挙げます。


### 1. 速度が重要視される

データのテストでは、データが反復するという性質上、チェック一つ一つのパフォーマンスが極めて重要です。単体テストや機能テストでは、このようなループが少ないため、アサーションのパフォーマンスが多少悪くても問題になりませんが、データの検証では、その影響が大きくなります。


### 2. テストケースの成否だけ判定すれば満足というわけではない

単体テストや機能テストでは、個々のテストケースの成否を判定すれば、それで満足でした。しかしデータの場合は、同じチェックを何度も行います。従って、従来のテストのような「成否だけの判定」では、1回だけ失敗したのか、全部失敗したのか、といった情報が欠落してしまいます。また、何をもって「テストケース」と呼ぶのか、についても再考の余地があります。


### 3. テストも一つのソフトウェアとして扱われる

データのテストでは、前述のようにループを行うため、処理が従来のテストコードより複雑になります。また、あらゆるデータに対して、繰り返しテストを実施することが求められます。そのためデータテストは、一つのソフトウェアとしてきちんと設計されなければなりません。


このように、データのテストは従来のテストとは異なる扱いが必要です。Dtest は、このようなデータ検証に役立つ環境を提供します。


2. Features
--------------

Dtest は、一般的な単体テストフレームワーク等によくあるアサーションライブラリですが、下記のような特徴があります。


### 1. シンプルなコンポーネント

Dtest は、フレームワークというよりは、単なるコンポーネントです。なぜこのような設計にしたかというと、テストの処理の流れはデータの構造によって非常に多様となるからです。


### 2. アサーションを最適化

高速に動作するような設計となっています。静的に展開されるような工夫を徹底的に施し、動作もシンプルです。


### 3. アサーション = テストケース

各アサーションに名前をつけます。これがテストケースの扱いとなります。


### 4. アサーションの結果を返却値として利用できる

地味ですが非常に重要です。なぜならば、データのテストソフトウェアを開発するにあたり、テストの結果により処理を切り替えるという需要が生じるからです。


### 5. テストは述語記述

アサーションの条件設定は、JUnit や Google Test 等で採用されている、AssertThat の述語記法に (今のところ) 統一しています。テストの可読性を上げる上で、役に立つでしょう。


### 6. 結果はCSV形式で出力する

データテストの結果も、一つのデータです。これを解析しやすくするために、CSV形式のテスト失敗ログを出力します。もちろんファイル出力もできます。


3. Usage
---------

### 1. テストマネージャを生成

```c++
dtest::DtestManager manager;
```

### 2. 出力ストリームを設定

```c++
std::ofstream ofs("dtest_log.csv");
manager.SetDetailStream(&ofs);
manager.SetUp();
```

- 設定しない場合、何も出力されません。

### 3. テストを実行

```c++
manager.TestThat("TestName", tested_variable, dtest::Eq(0));
```

- 失敗するとログを出力します。
- 第4引数に追加情報を含めることができます。"<<"演算子が定義されていれば、ユーザ定義のオブジェクトでも構いません。

